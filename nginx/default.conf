# nginx/default.conf

server {
    listen 80;
    server_name localhost;

    root /app;
    index index.html; # O index.php é tratado no bloco de localização do PHP

    # ======================================================
    # Rota da API - Processar os arquivos PHP do back-end
    # Este bloco deve vir ANTES do bloco genérico "location /"
    # ======================================================
    location ~ \.php$ {
        try_files $uri =404;
        include       fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass  app:9000;
    }

    # ======================================================
    # Rota Principal - Servir arquivos estáticos e o front-end
    # ======================================================
    location / {
        # Tenta encontrar um arquivo exato (ex: /front/style.css)
        # ou um diretório exato (ex: /front/cadastro_usuario/).
        # Se NENHUM dos dois for encontrado, passa o controle para o bloco @fallback.
        try_files $uri $uri/ @fallback;
    }

    # ======================================================
    # Bloco de Fallback - Ponto final para quebrar o loop
    # ======================================================
    location @fallback {
        # Serve a página principal do front-end.
        # Como este bloco não tem try_files, ele não pode entrar em loop.
        rewrite .* /front/principal_externa/index.html break;
    }
}
